#!/bin/bash

echo "Running on Openshift.  This script check memory settings against QoS."
echo "Initial settings : "
echo "pm.max_children=${PHP_FPM_MAX_CHILDREN}"
echo "php_value[memory_limit]=${PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES}"
echo "Ratio=${CONTAINER_HEAP_PERCENT}"

# calculate and set max_clients
. /usr/local/bin/dynamic_resources
CALCULATED_CLIENTS=`get_max_clients`
if [ -n "$CALCULATED_CLIENTS" ]; then
  PHP_FPM_MAX_CHILDREN=$CALCULATED_CLIENTS
  if [ $CALCULATED_CLIENTS -lt 1 ]; then
    exit 1
  fi
fi

echo "After calculation : "
echo "pm.max_children=${PHP_FPM_MAX_CHILDREN}"
echo "php_value[memory_limit]=${PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES}"
echo "Ratio=${CONTAINER_HEAP_PERCENT}"

# Always Replace with values with correct default values in PHP.INI (Based on PublicWeb Acceptance Environment (RH7))
sed -i 's/^expose_php.*/expose_php = Off/g' /etc/php7/php.ini

# Always Replace with values with correct default values in PHP-FPM.CONF (Based on PublicWeb Acceptance Environment (RH7))
sed -i 's/^error_log.*/error_log = \/var\/log\/php-fpm\/fpm-error.log/g' /etc/php7/php-fpm.conf
sed -i 's/^;access.log.*/access.log = \/var\/log\/php-fpm\/fpm-access.log/g' /etc/php7/php-fpm.conf
sed -i 's/^user.*/user = default/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^group.*/group = root/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^listen.*/listen = \/var\/run\/php-fpm\/php-fpm.sock/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^;listen.mode.*/listen.mode = 0777/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^;listen.allowed_clients.*/listen.allowed_clients = 127.0.0.1/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^;php_value\[session.save_handler\].*/php_value\[session.save_handler\] = files/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^;php_value\[session.save_path\].*/php_value\[session.save_path\] = \/var\/php\/session/g' /etc/php7/php-fpm.d/www.conf
sed -i 's/^;php_value\[soap.wsdl_cache_dir\].*/php_value\[soap.wsdl_cache_dir\] = \/var\/php\/wsdlcache/g' /etc/php7/php-fpm.d/www.conf

sed -i "s/^php_admin_value\[memory_limit\].*/php_admin_value\[memory_limit\] = ${PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES}M/g" /etc/php7/php-fpm.d/www.conf
sed -i "s/^pm.max_children.*/pm.max_children = ${PHP_FPM_MAX_CHILDREN}/g" /etc/php7/php-fpm.d/www.conf

echo "migrate db"
php /opt/src/bin/console doctrine:migrations:migrate --no-interaction

echo "install assets"
php /opt/src/bin/console asset:install /opt/src/public --symlink --no-interaction

echo "cache warm up"
php /opt/src/bin/console cache:warm --no-interaction

/usr/sbin/php-fpm7 -F -R
